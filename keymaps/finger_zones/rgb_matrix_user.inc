// Finger Zone RGB Effect for Framework 16 ANSI Keyboard
// Maps each key to a finger zone for touch typing visualization
//
// 6 Zones:
//   0 = Pinkies (both) - Pink
//   1 = Ring fingers   - Yellow
//   2 = Middle fingers - Blue
//   3 = Left index     - Green
//   4 = Thumbs         - Cyan
//   5 = Right index    - Orange
//
// Mapping derived from cross-referencing LAYOUT macro in ansi.h
// with g_led_config matrix-to-LED mapping in ansi.c

RGB_MATRIX_EFFECT(FINGER_ZONES)

#ifdef RGB_MATRIX_CUSTOM_EFFECT_IMPLS

#include "matrix.h"

// Zone assignments for each LED index (0-96)
// Generated by tracing K## codes through LAYOUT -> matrix -> g_led_config
static const uint8_t PROGMEM g_led_zone[RGB_MATRIX_LED_COUNT] = {
    0,  // LED  1 (idx  0): Tab (2nd LED) - Pinky
    0,  // LED  2 (idx  1): Tab - Pinky
    2,  // LED  3 (idx  2): E - Middle
    1,  // LED  4 (idx  3): W - Ring
    3,  // LED  5 (idx  4): R - Left Index
    0,  // LED  6 (idx  5): Q - Pinky
    5,  // LED  7 (idx  6): U - Right Index
    3,  // LED  8 (idx  7): T - Left Index
    5,  // LED  9 (idx  8): Y - Right Index
    3,  // LED 10 (idx  9): 5 - Left Index
    5,  // LED 11 (idx 10): 7 - Right Index
    3,  // LED 12 (idx 11): 4 - Left Index
    2,  // LED 13 (idx 12): 3 - Middle
    1,  // LED 14 (idx 13): 2 - Ring
    5,  // LED 15 (idx 14): 6 - Right Index
    0,  // LED 16 (idx 15): 1 - Pinky
    0,  // LED 17 (idx 16): ` - Pinky
    2,  // LED 18 (idx 17): 8 - Middle
    2,  // LED 19 (idx 18): vUp (F4) - Middle
    1,  // LED 20 (idx 19): vDn (F3) - Ring
    3,  // LED 21 (idx 20): Prv (F5) - Left Index
    0,  // LED 22 (idx 21): Mute (F1) - Pinky
    3,  // LED 23 (idx 22): Ply (F6) - Left Index
    0,  // LED 24 (idx 23): ESC (2nd LED) - Pinky
    5,  // LED 25 (idx 24): Nxt (F7) - Right Index
    0,  // LED 26 (idx 25): ESC - Pinky
    5,  // LED 27 (idx 26): bDn (F8) - Right Index
    0,  // LED 28 (idx 27): Z - Pinky
    0,  // LED 29 (idx 28): Caps (2nd LED) - Pinky
    1,  // LED 30 (idx 29): X - Ring
    0,  // LED 31 (idx 30): Caps (3rd LED) - Pinky
    2,  // LED 32 (idx 31): C - Middle
    0,  // LED 33 (idx 32): LShift - Pinky
    3,  // LED 34 (idx 33): V - Left Index
    0,  // LED 35 (idx 34): LCtrl - Pinky
    3,  // LED 36 (idx 35): B - Left Index
    0,  // LED 37 (idx 36): A - Pinky
    2,  // LED 38 (idx 37): D - Middle
    0,  // LED 39 (idx 38): LShift (2nd LED) - Pinky
    3,  // LED 40 (idx 39): G - Left Index
    5,  // LED 41 (idx 40): H - Right Index
    1,  // LED 42 (idx 41): S - Ring
    0,  // LED 43 (idx 42): LShift (3rd LED) - Pinky
    3,  // LED 44 (idx 43): F - Left Index
    0,  // LED 45 (idx 44): Caps - Pinky
    0,  // LED 46 (idx 45): LCtrl (2nd LED) - Pinky
    4,  // LED 47 (idx 46): GUI - Thumb
    4,  // LED 48 (idx 47): LAlt - Thumb
    0,  // LED 49 (idx 48): ; - Pinky
    5,  // LED 50 (idx 49): J - Right Index
    2,  // LED 51 (idx 50): K - Middle
    1,  // LED 52 (idx 51): L - Ring
    0,  // LED 53 (idx 52): ' - Pinky
    0,  // LED 54 (idx 53): Enter (2nd LED) - Pinky
    0,  // LED 55 (idx 54): ] - Pinky
    0,  // LED 56 (idx 55): \ - Pinky
    0,  // LED 57 (idx 56): Enter - Pinky
    0,  // LED 58 (idx 57): [ - Pinky
    2,  // LED 59 (idx 58): I - Middle
    1,  // LED 60 (idx 59): O - Ring
    0,  // LED 61 (idx 60): P - Pinky
    0,  // LED 62 (idx 61): 0 - Pinky
    0,  // LED 63 (idx 62): = - Pinky
    0,  // LED 64 (idx 63): - - Pinky
    0,  // LED 65 (idx 64): Bksp (2nd LED) - Pinky
    0,  // LED 66 (idx 65): Bksp - Pinky
    0,  // LED 67 (idx 66): Prt (F12) - Pinky
    2,  // LED 68 (idx 67): bUp (F9) - Middle
    0,  // LED 69 (idx 68): Air (F11) - Pinky
    1,  // LED 70 (idx 69): 9 - Ring
    0,  // LED 71 (idx 70): App - Pinky
    0,  // LED 72 (idx 71): PrtSc (2nd LED) - Pinky (NOT Del!)
    0,  // LED 73 (idx 72): Del (2nd LED) - Pinky
    0,  // LED 74 (idx 73): Del - Pinky
    1,  // LED 75 (idx 74): Scn (F10) - Ring
    1,  // LED 76 (idx 75): . - Ring
    5,  // LED 77 (idx 76): N - Right Index
    5,  // LED 78 (idx 77): M - Right Index
    2,  // LED 79 (idx 78): , - Middle
    0,  // LED 80 (idx 79): / - Pinky
    0,  // LED 81 (idx 80): RShift (2nd LED) - Pinky
    6,  // LED 82 (idx 81): Up - Arrow (Red)
    0,  // LED 83 (idx 82): RShift (3rd LED) - Pinky
    0,  // LED 84 (idx 83): RShift (4th LED) - Pinky
    4,  // LED 85 (idx 84): RAlt - Thumb
    4,  // LED 86 (idx 85): Space (2nd LED) - Thumb
    4,  // LED 87 (idx 86): Space (3rd LED) - Thumb
    4,  // LED 88 (idx 87): Space (4th LED) - Thumb
    0,  // LED 89 (idx 88): RCtrl - Pinky
    6,  // LED 90 (idx 89): Left - Arrow (Red)
    6,  // LED 91 (idx 90): Down - Arrow (Red)
    6,  // LED 92 (idx 91): Right - Arrow (Red)
    0,  // LED 93 (idx 92): RShift - Pinky
    4,  // LED 94 (idx 93): Fn - Thumb
    4,  // LED 95 (idx 94): Space - Thumb
    4,  // LED 96 (idx 95): Space (5th LED) - Thumb
    4,  // LED 97 (idx 96): Space (6th LED) - Thumb
};

// Zone colors in RGB format
static const uint8_t PROGMEM zone_colors[7][3] = {
    {255, 105, 180},   // 0: Pinkies      - Pink
    {255, 220,   0},   // 1: Ring fingers - Yellow
    { 50, 100, 255},   // 2: Middle       - Blue
    { 50, 255,  50},   // 3: Left index   - Green
    {  0, 255, 255},   // 4: Thumbs       - Cyan
    {255, 140,   0},   // 5: Right index  - Orange
    {255,  30,  30},   // 6: Arrow keys   - Red
};

// Map auxiliary LED indices to their primary LED (the one with matrix mapping)
// Multi-LED keys need aux LEDs to follow primary's behavior
static uint8_t get_primary_led(uint8_t led_index) {
    switch (led_index) {
        case 0: return 1;              // Tab aux -> Tab primary
        case 23: return 25;            // ESC aux -> ESC primary
        case 28: case 30: return 44;   // Caps aux -> Caps primary
        case 38: case 42: return 32;   // LShift aux -> LShift primary
        case 45: return 34;            // LCtrl aux -> LCtrl primary
        case 71: return 66;            // PrtSc aux -> PrtSc primary (NOT Del!)
        case 72: return 73;            // Del aux -> Del primary
        case 64: return 65;            // Backspace aux -> Backspace primary
        case 53: return 56;            // Enter aux -> Enter primary
        case 80: case 82: case 83: return 92;  // RShift aux -> RShift primary
        case 85: case 86: case 87: case 95: case 96: return 94;  // Space aux -> Space primary
        default: return led_index;     // Already primary or single-LED key
    }
}

// Find matrix position for a given LED index, returns true if found
static bool led_to_matrix(uint8_t led_index, uint8_t *row_out, uint8_t *col_out) {
    for (uint8_t row = 0; row < MATRIX_ROWS; row++) {
        for (uint8_t col = 0; col < MATRIX_COLS; col++) {
            if (g_led_config.matrix_co[row][col] == led_index) {
                *row_out = row;
                *col_out = col;
                return true;
            }
        }
    }
    return false;
}

// Check if LED at given index corresponds to a currently pressed key
static bool is_led_pressed(uint8_t led_index) {
    for (uint8_t row = 0; row < MATRIX_ROWS; row++) {
        for (uint8_t col = 0; col < MATRIX_COLS; col++) {
            if (matrix_is_on(row, col)) {
                if (g_led_config.matrix_co[row][col] == led_index) {
                    return true;
                }
            }
        }
    }
    return false;
}

// Check if LED index is a known F-row LED (for fallback when no matrix mapping)
static bool is_frow_led(uint8_t led_index) {
    switch (led_index) {
        case 18: case 19: case 20: case 21: case 22: case 24: case 26:  // F1-F8 area
        case 66: case 67: case 68: case 70: case 74:  // F9-F12, App area
            return true;
        default:
            return false;
    }
}

// Semantic colors for FN layer keys based on keycode (not LED index)
// Returns true if LED has semantic color, sets r/g/b
static bool get_fn_semantic_color(uint8_t led_index, uint8_t layer, uint8_t *r, uint8_t *g, uint8_t *b) {
    uint8_t row, col;
    if (!led_to_matrix(led_index, &row, &col)) {
        // F-row LEDs without matrix mapping: show blue (F-key color) as fallback
        if (is_frow_led(led_index)) {
            *r = 50; *g = 100; *b = 255;
            return true;
        }
        return false;
    }

    uint16_t keycode = keymap_key_to_keycode(layer, (keypos_t){.row = row, .col = col});

    switch (keycode) {
        // Green: Volume controls
        case KC_MUTE:
        case KC_VOLD:
        case KC_VOLU:
            *r = 50; *g = 255; *b = 50;
            return true;

        // Purple: Media controls
        case KC_MPRV:
        case KC_MPLY:
        case KC_MNXT:
        case KC_MSEL:
            *r = 180; *g = 50; *b = 255;
            return true;

        // Yellow: Brightness & system display
        // Note: KC_SCRN is Framework custom keycode, handled via QK_KB range
        case KC_BRID:
        case KC_BRIU:
        case KC_AIRP:
        case KC_SYRQ:
        case KC_SCRL:
            *r = 255; *g = 220; *b = 0;
            return true;

        // Blue: F-keys
        case KC_F1: case KC_F2: case KC_F3: case KC_F4:
        case KC_F5: case KC_F6: case KC_F7: case KC_F8:
        case KC_F9: case KC_F10: case KC_F11: case KC_F12:
            *r = 50; *g = 100; *b = 255;
            return true;

        // Red: Pause/Break (KC_PAUS == KC_BRK)
        case KC_PAUS:
        case KC_PSCR:
            *r = 255; *g = 30; *b = 30;
            return true;

        // Cyan: RGB controls
        case RGB_TOG:
        case RGB_MOD:
        case RGB_RMOD:
        case RGB_HUI:
        case RGB_HUD:
        case RGB_SAI:
        case RGB_SAD:
        case RGB_SPI:
        case RGB_SPD:
        case RGB_VAI:
        case RGB_VAD:
            *r = 0; *g = 255; *b = 255;
            return true;

        // Orange: Dangerous (EE_CLR, QK_BOOT, FN_LOCK toggle)
        case EE_CLR:
        case QK_BOOT:
            *r = 255; *g = 140; *b = 0;
            return true;

        // White: Backlight controls
        case BL_BRTG:
        case BL_STEP:
            *r = 255; *g = 255; *b = 255;
            return true;

        // Magenta: Insert
        case KC_INS:
            *r = 255; *g = 0; *b = 255;
            return true;

        default:
            // Check for custom keycodes in SAFE_RANGE (RGB_FZ, FN_LOCK, etc)
            if (keycode >= QK_KB_0 && keycode <= QK_KB_31) {
                *r = 255; *g = 140; *b = 0;
                return true;
            }
            return false;
    }
}

static bool FINGER_ZONES(effect_params_t* params) {
    RGB_MATRIX_USE_LIMITS(led_min, led_max);

    // Check if FN layer is active (_FN=1 or _FM=3)
    uint8_t current_layer = get_highest_layer(layer_state);
    bool fn_active = (current_layer == 1 || current_layer == 3);

    for (uint8_t i = led_min; i < led_max; i++) {
        uint8_t r, g, b;

        // When FN held, use semantic colors or turn off inactive keys
        if (fn_active) {
            // For aux LEDs, check their primary LED's behavior
            uint8_t primary = get_primary_led(i);

            uint8_t sem_r, sem_g, sem_b;
            if (get_fn_semantic_color(primary, current_layer, &sem_r, &sem_g, &sem_b)) {
                // Apply brightness - aux LEDs get same color as primary
                uint8_t val = rgb_matrix_get_val();
                rgb_matrix_set_color(i, (sem_r * val) / 255, (sem_g * val) / 255, (sem_b * val) / 255);
                continue;
            }
            // Check primary LED's keycode - aux LEDs follow primary's on/off state
            uint8_t row, col;
            if (led_to_matrix(primary, &row, &col)) {
                uint16_t keycode = keymap_key_to_keycode(current_layer, (keypos_t){.row = row, .col = col});
                if (keycode == KC_TRNS || keycode == KC_NO) {
                    rgb_matrix_set_color(i, 0, 0, 0);
                    continue;
                }
            }
            // Keys with functions but no semantic color keep zone color
        }

        // ESC LEDs (indices 23, 25) show mode: pink=F-keys, orange=media
        if (i == 23 || i == 25) {
            // Check if default layer is _FN_LOCK (F-keys mode) or _BASE (media mode)
            // _FN_LOCK = 2, _BASE = 0
            if (get_highest_layer(default_layer_state) == 2) {
                // F-keys mode - Pink
                r = 255; g = 105; b = 180;
            } else {
                // Media mode - Orange
                r = 255; g = 140; b = 0;
            }
        }
        // Check if this key is currently pressed -> magenta
        else if (is_led_pressed(i)) {
            r = 255;
            g = 0;
            b = 255;
        } else {
            uint8_t zone = pgm_read_byte(&g_led_zone[i]);
            if (zone > 6) zone = 4; // fallback to thumb zone

            r = pgm_read_byte(&zone_colors[zone][0]);
            g = pgm_read_byte(&zone_colors[zone][1]);
            b = pgm_read_byte(&zone_colors[zone][2]);
        }

        // Apply brightness from current RGB matrix value setting
        uint8_t val = rgb_matrix_get_val();
        r = (r * val) / 255;
        g = (g * val) / 255;
        b = (b * val) / 255;

        rgb_matrix_set_color(i, r, g, b);
    }

    return rgb_matrix_check_finished_leds(led_max);
}

#endif // RGB_MATRIX_CUSTOM_EFFECT_IMPLS
